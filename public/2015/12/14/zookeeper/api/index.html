<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>ZooKeeper客户端基本操作 | Wiki</title>
  <meta name="author" content="Jassassin">
  
  <meta name="description" content="概述本文所有实验基于Apache zookeeper-3.4.6版本。
zkCli.sh$ZOOKEEPER_HOME/bin目录下存在以下可执行脚本:



脚本
说明




zkCleanup.sh
清理zookeeper历史数据，包括事务日志文件和快照数据文件


zkCli.sh
zook">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="ZooKeeper客户端基本操作"/>
  <meta property="og:site_name" content="Wiki"/>

  
    <meta property="og:image" content="undefined"/>
  

  
    <link rel="alternative" href="/atom.xml" title="Wiki" type="application/atom+xml">
  
  
    <link href="/favicon.ico" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">  
  <link rel="stylesheet" href="/css/sidenav.css" media="screen" type="text/css">  
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  

</head>

<body id="body" data-spy="scroll" data-target=".toc">
  <div class="container" id="container">
	<div class="content">
	  <div class="page-header">		
  <h1><a class="brand" href="/">Wiki</a><span class="split"></span><span class="title">ZooKeeper客户端基本操作</span><span class="date" id="title-date"><i class="fa fa-clock-o"></i> 2015-12-14</span></h1>
</div>		

<div class="row page">
  <!-- cols -->	
  
  <div class="col-xs-12 col-sm-3 col-md-3 toc"> 
	<!-- toc -->
<script type="text/javascript">
		jQuery(document).ready(function() {
 		   generateWikiTOC('.note', '.toc',  2 , 2 );
		});
</script>
  </div><!-- col-md-3 -->
  
  

  
  <div class="col-xs-12 col-sm-9 col-md-9 note">
	

	  <!-- content -->
	  <h2 id="概述">概述</h2><p>本文所有实验基于<a href="http://zookeeper.apache.org/doc/r3.4.6/" target="_blank" rel="external">Apache zookeeper-3.4.6</a>版本。</p>
<h2 id="zkCli-sh">zkCli.sh</h2><p><code>$ZOOKEEPER_HOME/bin</code>目录下存在以下可执行脚本:</p>
<table>
<thead>
<tr>
<th style="text-align:left">脚本</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">zkCleanup.sh</td>
<td style="text-align:left">清理zookeeper历史数据，包括事务日志文件和快照数据文件</td>
</tr>
<tr>
<td style="text-align:left">zkCli.sh</td>
<td style="text-align:left">zookeeper客户端</td>
</tr>
<tr>
<td style="text-align:left">zkEnv.sh</td>
<td style="text-align:left">zookeeper环境变量设置</td>
</tr>
<tr>
<td style="text-align:left">zkServer.sh</td>
<td style="text-align:left">zookeeper服务启动、终止、重启脚本</td>
</tr>
</tbody>
</table>
<h3 id="启动">启动</h3><p>默认情况下<code>sh zkCli.sh</code>会连接到本机zookeeper服务器.<br><img src="/imgs/zookeeper/1.jpg" alt="start-localhost"><br>也可通过<code>sh zkCli.sh -server hostIp:port</code>连接到其他zookeeper服务器.</p>
<h3 id="基本操作">基本操作</h3><p><img src="/imgs/zookeeper/2.jpg" alt="start-localhost"></p>
<h2 id="Java客户端API">Java客户端API</h2><p>zookeeper作为一个分布式服务框架，主要用来解决分布式数据一致性问题。其提供了多种语言的客户端API,这里主要是针对java客户端的基本操作。<br>maven依赖:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="title">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="title">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="title">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="title">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="title">version</span>&gt;</span>3.4.6<span class="tag">&lt;/<span class="title">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="创建会话">创建会话</h3><p>客户端可通过创建一个ZooKeeper实例来连接ZooKeeper服务器。需要注意的是该会话过程的建立是一个异步的过程，构造方法在客户端初始化之后立刻返回，此时并没有真正建立一个可用的会话，在会话周期中处于”CONNECTING”状态。当该会话真正创建完成之后，ZooKeeper服务端向对应的客户端发送一个事件通知连接建立完毕。下面是ZooKeeper提供的四种构造方法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * connectString	zookeeper服务器地址列表，格式host:port，多个服务器地址以","分隔。如"192.168.2.71:2181,192.168.2.72:2181"，同时还可指定连接根目录(Chroot)。</span><br><span class="line"> *		  	如"192.168.2.71:2181,192.168.2.72:2181/test",这样该次会话的根目录都会基于"/test"进行操作。这样可以实现资源隔离</span><br><span class="line"> * sessionTimeout	会话超时时间(毫秒)，在一个会话周期内，zookeeper客户端和服务器之间通过心跳检测机制来维持会话的有效性，如果在sessionTimeout时间内没有有效的心跳检测，则该次会话将会失效</span><br><span class="line"> * watcher		事件通知处理器</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ZooKeeper</span><span class="params">(String connectString, <span class="keyword">int</span> sessionTimeout, Watcher watcher)</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span><br><span class="line"> * canBeReadOnly	用于表示该次会话是否支持"Read-only"模式。默认情况下，当ZooKeeper集群中某个节点与其他大部分节点失去联系时，该机器将不再处理客户端的读写请求。但在"Read-only"模式下，该节点可以继续处理客户端读请求。</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title">ZooKeeper</span><span class="params">(String connectString, <span class="keyword">int</span> sessionTimeout, Watcher watcher, <span class="keyword">boolean</span> canBeReadOnly)</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span><br><span class="line"> * sessionId，sessionPasswd	分别代表会话id和会话密钥,通过这两个参数可以唯一确定一次客户端和服务器之间的会话，从而实现会话复用。可以通过在第一次实现会话之后获取这两个参数，再次连接时再将两个参数传递进去</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title">ZooKeeper</span><span class="params">(String connectString, <span class="keyword">int</span> sessionTimeout, Watcher watcher, <span class="keyword">long</span> sessionId, <span class="keyword">byte</span>[] sessionPasswd)</span> </span><br><span class="line"><span class="keyword">public</span> <span class="title">ZooKeeper</span><span class="params">(String connectString, <span class="keyword">int</span> sessionTimeout, Watcher watcher, <span class="keyword">long</span> sessionId, <span class="keyword">byte</span>[] sessionPasswd, <span class="keyword">boolean</span> canBeReadOnly)</span></span></span><br></pre></td></tr></table></figure></p>
<p>基本会话实现:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * zookeeper会话实例,注意该类同时实现了Watcher接口</span><br><span class="line"> * <span class="doctag">@author</span> eagle</span><br><span class="line"> * <span class="doctag">@date</span> 2015年12月15日</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZooKeeperSessionDemo</span> <span class="keyword">implements</span> <span class="title">Watcher</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> CountDownLatch connectSignal = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONNECT_STRING = <span class="string">"127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183/simple"</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_SESSION_TIMEOUT = <span class="number">5000</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		simpleConnect();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * 简单会话</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">simpleConnect</span><span class="params">()</span></span>&#123;</span><br><span class="line">		ZooKeeper client = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			client = <span class="keyword">new</span> ZooKeeper(CONNECT_STRING, DEFAULT_SESSION_TIMEOUT, <span class="keyword">new</span> ZooKeeperSessionDemo());</span><br><span class="line">			System.out.println(client.getState());</span><br><span class="line">			connectSignal.await();</span><br><span class="line">			System.out.println(<span class="string">"finish connected!"</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(client != <span class="keyword">null</span>)&#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					client.close();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		System.out.println(<span class="string">"Receive watched event:"</span> + event);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//连接建立完成</span></span><br><span class="line">		<span class="keyword">if</span>(KeeperState.SyncConnected == event.getState())&#123;</span><br><span class="line">			connectSignal.countDown();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>输出:<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CONNECTING&#10;Receive watched event:WatchedEvent state:SyncConnected type:None path:null&#10;finish connected!</span><br></pre></td></tr></table></figure></p>
<p>session复用测试:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 测试通过sessionId以及sessionPasswd复用会话连接</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createConnectBySeessionId</span><span class="params">()</span></span>&#123;</span><br><span class="line">	ZooKeeper client = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		client = <span class="keyword">new</span> ZooKeeper(CONNECT_STRING, DEFAULT_SESSION_TIMEOUT, <span class="keyword">new</span> ZooKeeperSessionDemo());</span><br><span class="line">		connectSignal.await();</span><br><span class="line">			</span><br><span class="line">		<span class="comment">//获取sessionId以及sessionPasswd</span></span><br><span class="line">		<span class="keyword">long</span> sessionId = client.getSessionId();</span><br><span class="line">		<span class="keyword">byte</span>[] sessionPasswd = client.getSessionPasswd();</span><br><span class="line">		System.out.println(<span class="string">"first connected session id:"</span> + sessionId);</span><br><span class="line">			</span><br><span class="line">		<span class="comment">//使用错误的sesssionId</span></span><br><span class="line">		ZooKeeper clientWithWrongSessionId = <span class="keyword">new</span> ZooKeeper(CONNECT_STRING, DEFAULT_SESSION_TIMEOUT, <span class="keyword">new</span> ZooKeeperSessionDemo(), <span class="keyword">new</span> Random().nextLong(), sessionPasswd);</span><br><span class="line">			</span><br><span class="line">		<span class="comment">//使用正确的sessionId以及sessionPasswd</span></span><br><span class="line">		client = <span class="keyword">new</span> ZooKeeper(CONNECT_STRING, DEFAULT_SESSION_TIMEOUT, <span class="keyword">new</span> ZooKeeperSessionDemo(), sessionId, sessionPasswd);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125; <span class="keyword">finally</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(client != <span class="keyword">null</span>)&#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				client.close();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>输出:<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Receive watched event:WatchedEvent state:SyncConnected type:None path:null&#10;first connected session id:167089735794753536&#10;Receive watched event:WatchedEvent state:Expired type:None path:null   //&#22797;&#29992;&#38169;&#35823;&#30340;sessionId&#65292;&#36830;&#25509;&#22833;&#36133;&#10;Receive watched event:WatchedEvent state:SyncConnected type:None path:null   //&#22797;&#29992;&#27491;&#30830;&#30340;sessionId</span><br></pre></td></tr></table></figure></p>
<h3 id="创建节点">创建节点</h3><p>zookeeper分别提供以下两种同步和异步的方式创建节点，同时注意临时节点是无法创建子节点的。</p>
<ol>
<li>同步方式</li>
</ol>
<p>调用接口:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 同步方式</span><br><span class="line"> * <span class="doctag">@param</span> path	节点路径</span><br><span class="line"> * <span class="doctag">@param</span> data	节点创建之后的初始化内容</span><br><span class="line"> * <span class="doctag">@param</span> acl	节点ACL策略</span><br><span class="line"> * <span class="doctag">@param</span> createMode	枚举类型,共4种. PERSISTENT(持久节点，会话结束会继续存在)/PERSISTENT_SEQUENTIAL(持久顺序型) </span><br><span class="line"> * 			EPHEMERAL（临时节点,会话结束则自动删除）/ EPHEMERAL_SEQUENTIAL(临时顺序型)</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">create</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">byte</span> data[], List&lt;ACL&gt; acl,CreateMode createMode)</span></span>&#123;</span><br></pre></td></tr></table></figure></p>
<p>实例:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 通过同步方式创建节点</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createZNodeSync</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException, KeeperException</span>&#123;</span><br><span class="line">	ZooKeeper client = <span class="keyword">new</span> ZooKeeper(CONNECT_STRING, DEFAULT_SESSION_TIMEOUT, <span class="keyword">new</span> ZooKeeperSessionDemo());</span><br><span class="line">	connectSignal.await();</span><br><span class="line">	String path = client.create(<span class="string">"/s1"</span>, <span class="string">"s1"</span>.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);</span><br><span class="line">	System.out.println(<span class="string">"finish create znode:"</span> + path);</span><br><span class="line">	path = client.create(<span class="string">"/s1"</span>, <span class="string">"s1"</span>.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);</span><br><span class="line">	System.out.println(<span class="string">"finish create znode:"</span> + path);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>输出:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Receive watched event:WatchedEvent state:SyncConnected type:None path:null&#10;finish create znode:/s1&#10;finish create znode:/s10000000002</span><br></pre></td></tr></table></figure>
<p>注意:以上操作均是在根目录/simple下操作(CONNECT_STRING = “127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183/simple”)。</p>
<ol>
<li>异步方式</li>
</ol>
<p>调用接口:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 异步方式</span><br><span class="line"> * <span class="doctag">@param</span> path	节点路径</span><br><span class="line"> * <span class="doctag">@param</span> data	节点创建之后的初始化内容</span><br><span class="line"> * <span class="doctag">@param</span> acl	节点ACL策略</span><br><span class="line"> * <span class="doctag">@param</span> createMode	枚举类型,共4种. PERSISTENT(持久节点，会话结束会继续存在)/PERSISTENT_SEQUENTIAL(持久顺序型) </span><br><span class="line"> * 									  EPHEMERAL（临时节点,会话结束则自动删除）/ EPHEMERAL_SEQUENTIAL(临时顺序型)</span><br><span class="line"> * <span class="doctag">@param</span> cb	注册一个回调函数。当服务器节点创建完成之后，客户端会自动调用该接口</span><br><span class="line"> * <span class="doctag">@param</span> ctx	用于传递一个对象，可以被传递到回调方法中。通常放置一个上下文信息</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">create</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">byte</span> data[], List&lt;ACL&gt; acl,CreateMode createMode,  StringCallback cb, Object ctx)</span></span></span><br></pre></td></tr></table></figure></p>
<p>demo:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 通过异步方式创建节点</span><br><span class="line"> * <span class="doctag">@throws</span> IOException </span><br><span class="line"> * <span class="doctag">@throws</span> InterruptedException </span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createZNodeAsync</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">	ZooKeeper client = <span class="keyword">new</span> ZooKeeper(CONNECT_STRING, DEFAULT_SESSION_TIMEOUT, <span class="keyword">new</span> ZooKeeperSessionDemo());</span><br><span class="line">	connectSignal.await();</span><br><span class="line">	</span><br><span class="line">	client.create(<span class="string">"/s1"</span>, <span class="string">"s1"</span>.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL, <span class="keyword">new</span> StringCallback() &#123;</span><br><span class="line">		</span><br><span class="line">		<span class="annotation">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processResult</span><span class="params">(<span class="keyword">int</span> rc, String path, Object ctx, String name)</span> </span>&#123;</span><br><span class="line">			System.out.println(<span class="string">"create path result:[rc:"</span> + rc + <span class="string">", path:"</span> + path + <span class="string">", ctx:"</span> + ctx + <span class="string">", name:"</span> + name + <span class="string">"]"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;, <span class="string">"hello"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//注意由于是异步创建,这里将线程sleep一会，以便打印结果</span></span><br><span class="line">	Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>输出:<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Receive watched event:WatchedEvent state:SyncConnected type:None path:null&#10;create path result:[rc:0, path:/s1, ctx:hello, name:/s10000000006]</span><br></pre></td></tr></table></figure></p>
<p>关于StringCallback中processResult()方法的相关说明:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">StringCallback</span> <span class="keyword">extends</span> <span class="title">AsyncCallback</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * </span><br><span class="line">	 * <span class="doctag">@param</span> rc	服务端响应码 </span><br><span class="line">	 *		0(OK):调用成功.	-4(ConnectionLoss):客户端与服务端断开连接	-100(NodeExists):指定节点已经存在	-112(SessionExpired):会话已过期</span><br><span class="line">	 * <span class="doctag">@param</span> path	接口调用时传入api的数据节点的节点路径参数</span><br><span class="line">	 * <span class="doctag">@param</span> ctx	接口调用时传入api的ctx的参数值</span><br><span class="line">	 * <span class="doctag">@param</span> name	实际在服务器端创建的节点</span><br><span class="line">	 */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processResult</span><span class="params">(<span class="keyword">int</span> rc, String path, Object ctx, String name)</span></span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p><strong> 关于同步和异步接口方法的最大区别在于，节点的创建过程(包括网络通信和服务端的节点创建过程)是异步的。在异步接口中，接口本身是不会抛出异常的，所有的异常都会在回调函数中通过Result Code来体现。</strong></p>
<h3 id="删除节点">删除节点</h3><p>和创建节点一样，删除节点同样提供了同步和异步两种。注意,如果被删除的节点同时存在子节点，则该节点将无法删除，除非先删除其所有子节点。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 异步删除</span><br><span class="line"> * <span class="doctag">@param</span> path		删除节点路径</span><br><span class="line"> * <span class="doctag">@param</span> version	数据版本,zookeeper中的数据版本从0开始递增。-1表示最新数据版本</span><br><span class="line"> * <span class="doctag">@param</span> cb		回调函数</span><br><span class="line"> * <span class="doctag">@param</span> ctx		上下文信息</span><br><span class="line"> */</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">int</span> version, VoidCallback cb,Object ctx)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * 同步删除</span><br><span class="line"> */</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">int</span> version)</span></span>;</span><br></pre></td></tr></table></figure>
<p>demo:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 通过同步方式创建节点</span><br><span class="line"> * <span class="doctag">@throws</span> IOException </span><br><span class="line"> * <span class="doctag">@throws</span> InterruptedException </span><br><span class="line"> * <span class="doctag">@throws</span> KeeperException </span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deleteZNodeSync</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException, KeeperException</span>&#123;</span><br><span class="line">	ZooKeeper client = <span class="keyword">new</span> ZooKeeper(CONNECT_STRING, DEFAULT_SESSION_TIMEOUT, <span class="keyword">new</span> ZooKeeperSessionDemo());</span><br><span class="line">	connectSignal.await();</span><br><span class="line">	String path = client.create(<span class="string">"/s1"</span>, <span class="string">"s1"</span>.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">	System.out.println(<span class="string">"finish create znode:"</span> + path);</span><br><span class="line">	List&lt;String&gt; children = client.getChildren(<span class="string">"/"</span>, <span class="keyword">false</span>);</span><br><span class="line">	System.out.println(<span class="string">"children:"</span> + children.toString());</span><br><span class="line">	client.delete(path, -<span class="number">1</span>);</span><br><span class="line">	System.out.println(<span class="string">"finish delete znode:"</span> + path);</span><br><span class="line">	children = client.getChildren(<span class="string">"/"</span>, <span class="keyword">false</span>);</span><br><span class="line">	System.out.println(<span class="string">"children:"</span> + children.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>输出:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Receive watched event:WatchedEvent state:SyncConnected type:None path:null&#10;finish create znode:/s1&#10;children:[s1]&#10;finish delete znode:/s1&#10;children:[]</span><br></pre></td></tr></table></figure></p>
<h3 id="读取数据">读取数据</h3><p>读取数据，包括或子节点以及当前节点的数据.</p>
<ol>
<li>获取子节点</li>
</ol>
<p>可以通过如下接口获取当前节点的子节点:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getChildren</span><span class="params">(<span class="keyword">final</span> String path, Watcher watcher)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getChildren</span><span class="params">(String path, <span class="keyword">boolean</span> watch)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getChildren</span><span class="params">(<span class="keyword">final</span> String path, Watcher watcher,ChildrenCallback cb, Object ctx)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getChildren</span><span class="params">(String path, <span class="keyword">boolean</span> watch, ChildrenCallback cb, Object ctx)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getChildren</span><span class="params">(<span class="keyword">final</span> String path, Watcher watcher,Stat stat)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getChildren</span><span class="params">(String path, <span class="keyword">boolean</span> watch, Stat stat)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getChildren</span><span class="params">(<span class="keyword">final</span> String path, Watcher watcher,Children2Callback cb, Object ctx)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getChildren</span><span class="params">(String path, <span class="keyword">boolean</span> watch, Children2Callback cb,Object ctx)</span></span>;</span><br></pre></td></tr></table></figure>
<p>参数说明</p>
<table>
<thead>
<tr>
<th style="text-align:left">参数</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">path</td>
<td style="text-align:left">节点路径</td>
</tr>
<tr>
<td style="text-align:left">watcher</td>
<td style="text-align:left">注册Ｗatcher。一旦在本次子节点获取之后，子节点列表发生变化，那么就会通过该watcher向客户端发送通知。该参数允许为null</td>
</tr>
<tr>
<td style="text-align:left">watch</td>
<td style="text-align:left">是否需要注册一个watcher。这里指默认watcher</td>
</tr>
<tr>
<td style="text-align:left">cb</td>
<td style="text-align:left">异步回调函数</td>
</tr>
<tr>
<td style="text-align:left">ctx</td>
<td style="text-align:left">上下文信息对象</td>
</tr>
<tr>
<td style="text-align:left">stat</td>
<td style="text-align:left">指定数据节点的节点状态信息。用法是在接口中传入一个旧的stat变量，该stat变量会在方法执行过程中，被来自服务器响应的新的stat对象替换</td>
</tr>
</tbody>
</table>
<p><strong> 需要注意的是，注册的Watcher当子节点发生变化时，服务端会向客户端发送一个NodeChildrenChanged(EventType.NodeChildrenChanged)类型的事件通知。注意，该通知中并没有包含最新的节点列表，最新的节点列表客户端必须主动重新获取。</strong></p>
<p>同步获取子节点:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 同步获取子节点列表</span><br><span class="line"> * </span><br><span class="line"> * <span class="doctag">@throws</span> IOException</span><br><span class="line"> * <span class="doctag">@throws</span> InterruptedException</span><br><span class="line"> * <span class="doctag">@throws</span> KeeperException</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getChildrenSync</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException, KeeperException</span>&#123;</span><br><span class="line">	<span class="keyword">final</span> ZooKeeper client = <span class="keyword">new</span> ZooKeeper(CONNECT_STRING, DEFAULT_SESSION_TIMEOUT, <span class="keyword">new</span> ZooKeeperSessionDemo());</span><br><span class="line">	connectSignal.await();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//获取子节点,注意这里的"/"即"/simple"，连接时由CONNECT_STRING指定"127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183/simple";</span></span><br><span class="line">	client.getChildren(<span class="string">"/"</span>, <span class="keyword">new</span> Watcher()&#123;</span><br><span class="line"></span><br><span class="line">		<span class="annotation">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(EventType.NodeChildrenChanged == event.getType())&#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">						System.out.println(<span class="string">"receive node changed event. reload children:"</span> +  client.getChildren(event.getPath(), <span class="keyword">true</span>));</span><br><span class="line">					&#125; <span class="keyword">catch</span> (KeeperException e) &#123;</span><br><span class="line">						e.printStackTrace();</span><br><span class="line">					&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">						e.printStackTrace();</span><br><span class="line">					&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">				</span><br><span class="line">	&#125;);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//创建子节点/simple/s1</span></span><br><span class="line">	String path = client.create(<span class="string">"/s1"</span>, <span class="string">"s1"</span>.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);</span><br><span class="line">	System.out.println(<span class="string">"finish create znode:"</span> + path);</span><br><span class="line">	</span><br><span class="line">	path = client.create(<span class="string">"/s2"</span>, <span class="string">"s2"</span>.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);</span><br><span class="line">	System.out.println(<span class="string">"finish create znode:"</span> + path);</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>输出:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">finish create znode:/s1&#10;receive node changed event. reload children:[s1]&#10;finish create znode:/s2</span><br></pre></td></tr></table></figure></p>
<p><strong> 注:由上面输出可以看出,在创建子节点/s1时，触发了node changed事件。但是在创建/s2时并没有触发该事件，这是由于getChildren()中的Watcher一旦触发一次之后就失效了，需要客户端自己再重新注册!</strong></p>
<p>异步:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 异步获取子节点列表</span><br><span class="line"> * </span><br><span class="line"> * <span class="doctag">@throws</span> IOException</span><br><span class="line"> * <span class="doctag">@throws</span> InterruptedException</span><br><span class="line"> * <span class="doctag">@throws</span> KeeperException</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getChildrenAsync</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException, KeeperException</span>&#123;</span><br><span class="line">	<span class="keyword">final</span> ZooKeeper client = <span class="keyword">new</span> ZooKeeper(CONNECT_STRING, DEFAULT_SESSION_TIMEOUT, <span class="keyword">new</span> ZooKeeperSessionDemo());</span><br><span class="line">	connectSignal.await();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//创建子节点/simple/s1</span></span><br><span class="line">	String path = client.create(<span class="string">"/s1"</span>, <span class="string">"s1"</span>.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);</span><br><span class="line">	System.out.println(<span class="string">"finish create znode:"</span> + path);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//获取子节点,注意这里的"/"即"/simple"，连接时由CONNECT_STRING指定"127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183/simple";</span></span><br><span class="line">	client.getChildren(<span class="string">"/"</span>, <span class="keyword">true</span>, <span class="keyword">new</span> AsyncCallback.Children2Callback()&#123;</span><br><span class="line"></span><br><span class="line">				<span class="annotation">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processResult</span><span class="params">(<span class="keyword">int</span> rc, String path, Object ctx, List&lt;String&gt; children, Stat stat)</span> </span>&#123;</span><br><span class="line">					System.out.println(<span class="string">"async get children:[response code:"</span> + rc + <span class="string">", path:"</span> + path + <span class="string">", ctx:"</span> + ctx + <span class="string">", children:"</span> + children.toString() + <span class="string">", stat:"</span> + stat + <span class="string">"]"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				</span><br><span class="line">			&#125;, <span class="string">"hello"</span>);</span><br><span class="line">	</span><br><span class="line">	path = client.create(<span class="string">"/s2"</span>, <span class="string">"s2"</span>.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);</span><br><span class="line">	System.out.println(<span class="string">"finish create znode:"</span> + path);</span><br><span class="line">	</span><br><span class="line">	Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>输出:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">finish create znode:/s1&#10;async get children:[response code:0, path:/, ctx:hello, children:[s1], stat:25769803785,25769803785,1450153810191,1450153810191,0,59,0,0,11,1,25769803877]&#10;finish create znode:/s2</span><br></pre></td></tr></table></figure></p>
<ol>
<li>getData</li>
</ol>
<p>getData()接口和getChildren()接口参数意义基本相同.当节点数据发生变化时,服务端会发送ＮodeDataChanged通知.</p>
<p>同步方式:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZooKeeperGetDataDemo</span> <span class="keyword">implements</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> CountDownLatch connectSignal = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONNECT_STRING = <span class="string">"127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183/simple"</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_SESSION_TIMEOUT = <span class="number">5000</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> ZooKeeper client;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Stat stat = <span class="keyword">new</span> Stat();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> KeeperException, InterruptedException</span>&#123;</span><br><span class="line">		client = initClient();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//创建"/simple/test1"</span></span><br><span class="line">		String path = client.create(<span class="string">"/test1"</span>, <span class="string">"test1"</span>.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);</span><br><span class="line">		System.out.println(<span class="string">"success create path:"</span> + path);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//获取数据,注册Watcher</span></span><br><span class="line">		String data = <span class="keyword">new</span> String(client.getData(path, <span class="keyword">new</span> ZooKeeperGetDataDemo(), stat));</span><br><span class="line">		System.out.println(<span class="string">"data:"</span> + data);</span><br><span class="line">		System.out.println(<span class="string">"stat:"</span> + stat.getCzxid() + <span class="string">","</span> + stat.getMzxid() + <span class="string">","</span> + stat.getVersion());</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//更新数据,-1指当前数据的最新版本</span></span><br><span class="line">		client.setData(path, <span class="string">"test2"</span>.getBytes(), -<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ZooKeeper <span class="title">initClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		ZooKeeper client = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			client = <span class="keyword">new</span> ZooKeeper(CONNECT_STRING, DEFAULT_SESSION_TIMEOUT,<span class="keyword">new</span> ZooKeeperGetDataDemo());</span><br><span class="line">			connectSignal.await();</span><br><span class="line">			System.out.println(<span class="string">"finish connected!"</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> client;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(KeeperState.SyncConnected == event.getState())&#123;</span><br><span class="line">			<span class="keyword">if</span>(EventType.None == event.getType() &amp;&amp; event.getPath() == <span class="keyword">null</span>)&#123;</span><br><span class="line">				connectSignal.countDown();</span><br><span class="line">			&#125;<span class="keyword">else</span> <span class="keyword">if</span>(EventType.NodeDataChanged == event.getType())&#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					System.out.println(<span class="string">"process data:"</span> + <span class="keyword">new</span> String(client.getData(event.getPath(), <span class="keyword">true</span>, stat)));</span><br><span class="line">					System.out.println(<span class="string">"process stat:"</span> + stat.getCzxid() + <span class="string">","</span> + stat.getMzxid() + <span class="string">","</span> + stat.getVersion());</span><br><span class="line">				&#125; <span class="keyword">catch</span> (KeeperException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>输出:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">finish connected!&#10;success create path:/test1&#10;data:test1&#10;stat:25769803885,25769803885,0&#10;process data:test2&#10;process stat:25769803885,25769803886,1</span><br></pre></td></tr></table></figure></p>
<p><strong> 注意NodeDataChanged触发条件是节点数据内容变化或数据版本变更,同时注意其中Stat使用方式 </strong></p>
<h3 id="数据更新">数据更新</h3><p>数据更新接口:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Stat <span class="title">setData</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">byte</span> data[], <span class="keyword">int</span> version)</span></span>;</span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * </span><br><span class="line"> * <span class="doctag">@param</span> path</span><br><span class="line"> * <span class="doctag">@param</span> data</span><br><span class="line"> * <span class="doctag">@param</span> version	指定数据版本即本次数据变更针对的版本</span><br><span class="line"> * <span class="doctag">@param</span> cb</span><br><span class="line"> * <span class="doctag">@param</span> ctx</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">byte</span> data[], <span class="keyword">int</span> version,StatCallback cb, Object ctx)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p><strong> 关于数据版本,zookeeper每个节点都有数据版本的概念,在调用更新操作的时候可以添加version参数,该参数对应于”CAS”原理中的”预期值”,表明是针对该数据版本进行更新的.也就是说,当一个客户端试图进行更新操作,它会携带上次获取到的version值进行更新.而如果在这段时间内,zookeeper服务器上该节点数据恰好已经被其他客户端更新了,那么其数据版本一定也会发生变化,因此会与客户端携带的version无法匹配,于是便会更新失败.这样可以有效的避免一些分布式更新的并发问题.而zookeeper客户端就可以利用该特性构建更复杂的应用场景如分布式锁服务等. </strong></p>
<h3 id="权限控制">权限控制</h3><p>使用方式:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * scheme zookeeper分别提供了world, auth, digest, ip以及super等几种</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addAuthInfo</span><span class="params">(String scheme, <span class="keyword">byte</span> auth[])</span></span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZooKeeperACLDemo</span> <span class="keyword">implements</span> <span class="title">Watcher</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> CountDownLatch connectSignal = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONNECT_STRING = <span class="string">"127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183/simple"</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_SESSION_TIMEOUT = <span class="number">5000</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> KeeperException, InterruptedException </span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//1.使用带有权限认证的客户端创建节点"/acl-test"</span></span><br><span class="line">		ZooKeeper client = initClient();</span><br><span class="line">		<span class="comment">//附加权限认证</span></span><br><span class="line">		client.addAuthInfo(<span class="string">"digest"</span>, <span class="string">"eagle:eagle"</span>.getBytes());</span><br><span class="line">		<span class="comment">//创建节点"/simple/acl-test"</span></span><br><span class="line">		String path = client.create(<span class="string">"/acl-test2"</span>, <span class="string">"/acl-test2"</span>.getBytes(), Ids.CREATOR_ALL_ACL, CreateMode.PERSISTENT);</span><br><span class="line">		System.out.println(<span class="string">"success create znode:"</span> + path + <span class="string">" with auth info!"</span>);</span><br><span class="line">		<span class="comment">//关闭连接</span></span><br><span class="line">		client.close();</span><br><span class="line">		connectSignal = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>); </span><br><span class="line">		</span><br><span class="line">		<span class="comment">//2.使用没有权限认证的客户端,创建子节点"/acl-test/test1"</span></span><br><span class="line">		client = initClient();</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span>&#123;</span><br><span class="line">			client.create(path + <span class="string">"/test2"</span>, <span class="string">"/acl-test2/test2"</span>.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">		&#125; <span class="keyword">catch</span>(Throwable e)&#123;</span><br><span class="line">			System.err.println(<span class="string">"failed create "</span> + (path + <span class="string">"/test2 without auth info, caused by:"</span>) +  e.getMessage());</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//3.添加权限认证,创建子节点"/acl-test/test1"</span></span><br><span class="line">		client.addAuthInfo(<span class="string">"digest"</span>, <span class="string">"eagle:eagle"</span>.getBytes());</span><br><span class="line">		<span class="keyword">try</span>&#123;</span><br><span class="line">			path = client.create(path + <span class="string">"/test2"</span>, <span class="string">"/acl-test2/test2"</span>.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">			System.out.println(<span class="string">"success create with auth info for path:"</span> + path);</span><br><span class="line">		&#125; <span class="keyword">catch</span>(Throwable e)&#123;</span><br><span class="line">			System.err.println(e.getMessage());</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		client.close();</span><br><span class="line">		connectSignal = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>); </span><br><span class="line">		client = initClient();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//4.使用无权限认证的客户端删除"/simple/acl-test/test1"</span></span><br><span class="line">		<span class="keyword">try</span>&#123;</span><br><span class="line">			client.delete(<span class="string">"/acl-test2/test2"</span>, -<span class="number">1</span>);</span><br><span class="line">			System.out.println(<span class="string">"success delete path:/acl-test2/test2 without auth info!"</span>);</span><br><span class="line">		&#125;<span class="keyword">catch</span>(Throwable e)&#123;</span><br><span class="line">			System.err.println(<span class="string">"failed delete path:/acl-test2/test2 without auth info!"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//5.使用有权限认证的客户端删除"/simple/acl-test/test1"</span></span><br><span class="line">		client.addAuthInfo(<span class="string">"digest"</span>, <span class="string">"eagle:eagle"</span>.getBytes());</span><br><span class="line">		<span class="keyword">try</span>&#123;</span><br><span class="line">			client.delete(<span class="string">"/acl-test2/test2"</span>, -<span class="number">1</span>);</span><br><span class="line">			System.out.println(<span class="string">"success delete path:/acl-test2/test2 with auth info!"</span>);</span><br><span class="line">		&#125;<span class="keyword">catch</span>(Throwable e)&#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//6.使用无权限认证的客户端删除"/simple/acl-test"</span></span><br><span class="line">		client.close();</span><br><span class="line">		connectSignal = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>); </span><br><span class="line">		client = initClient();</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span>&#123;</span><br><span class="line">			client.delete(<span class="string">"/acl-test2"</span>, -<span class="number">1</span>);</span><br><span class="line">			System.out.println(<span class="string">"success delete path:/acl-test2 without auth info!"</span>);</span><br><span class="line">		&#125;<span class="keyword">catch</span>(Throwable e)&#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ZooKeeper <span class="title">initClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		ZooKeeper client = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			client = <span class="keyword">new</span> ZooKeeper(CONNECT_STRING, DEFAULT_SESSION_TIMEOUT,<span class="keyword">new</span> ZooKeeperACLDemo());</span><br><span class="line">			connectSignal.await();</span><br><span class="line">			System.out.println(<span class="string">"finish connected!"</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> client;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(KeeperState.SyncConnected == event.getState())&#123;</span><br><span class="line">			connectSignal.countDown();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">finish connected!&#10;success create znode:/acl-test2 with auth info!&#10;finish connected!&#10;failed create /acl-test2/test2 without auth info, caused by:KeeperErrorCode = NoAuth for /acl-test2/test2&#10;success create with auth info for path:/acl-test2/test2&#10;finish connected!&#10;failed delete path:/acl-test2/test2 without auth info!&#10;success delete path:/acl-test2/test2 with auth info!&#10;finish connected!&#10;success delete path:/acl-test2 without auth info!</span><br></pre></td></tr></table></figure></p>
<p><strong> 值得注意的是在前面6中的操作是成功的,也就是说对一个节点添加权限之后,对于其删除权限作用范围是其子节点,当这个节点的所有子节点均被删除之后,该节点依然可以被没有认证信息的客户端删除 </strong></p>
<h2 id="开源客户端Curator">开源客户端Curator</h2><h3 id="简介">简介</h3><p>Curator是Netflix开源的一套ZooKeeper客户端框架.和ZkClient一样,Curator解决了很多zookeeper客户端非常底层的细节开发工作,包括连接重连,反复注册Watcher和NodeExistsException异常等,目前已成为Apache顶级项目.详细介绍可参考<a href="http://macrochen.iteye.com/blog/1366136" target="_blank" rel="external">Zookeeper开源客户端框架Curator简介</a>.</p>
<p>maven依赖:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="title">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="title">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="title">artifactId</span>&gt;</span>curator-framework<span class="tag">&lt;/<span class="title">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="title">version</span>&gt;</span>2.7.1<span class="tag">&lt;/<span class="title">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="简单实例">简单实例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * zookeeper开源客户端框架Curator测试</span><br><span class="line"> * <span class="doctag">@author</span> eagle</span><br><span class="line"> * <span class="doctag">@date</span> 2015年12月15日</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * 初始sleep时间(毫秒)</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BASE_SLEEP_TIME = <span class="number">1000</span>;</span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * 最大重试次数</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_RETRIES_COUNT = <span class="number">5</span>;</span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * 最大sleep时间</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_SLEEP_TIME = <span class="number">60000</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONNECT_STRING = <span class="string">"127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183"</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SESSION_TIMEOUT = <span class="number">5000</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONNECTION_TIMEOUT = <span class="number">5000</span>;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		CuratorFramework client = initClient();</span><br><span class="line">		String destPath = <span class="string">"/curator-test/test1"</span>;</span><br><span class="line">		createData(client, destPath);</span><br><span class="line">		deleteData(client, destPath);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * 初始化客户端</span><br><span class="line">	 * <span class="doctag">@return</span></span><br><span class="line">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> CuratorFramework <span class="title">initClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">//1.设置重试策略,重试时间计算策略sleepMs = baseSleepTimeMs * Math.max(1, random.nextInt(1 &lt;&lt; (retryCount + 1)));</span></span><br><span class="line">		RetryPolicy retryPolicy = <span class="keyword">new</span> ExponentialBackoffRetry(BASE_SLEEP_TIME, MAX_RETRIES_COUNT, MAX_SLEEP_TIME);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//2.使用Fluent风格初始化客户端</span></span><br><span class="line">		CuratorFramework client = CuratorFrameworkFactory.builder()</span><br><span class="line">									.connectString(CONNECT_STRING)</span><br><span class="line">									.sessionTimeoutMs(SESSION_TIMEOUT)</span><br><span class="line">									.connectionTimeoutMs(CONNECTION_TIMEOUT)</span><br><span class="line">									.retryPolicy(retryPolicy)</span><br><span class="line">									.namespace(<span class="string">"simple"</span>)		<span class="comment">//命名空间隔离</span></span><br><span class="line">									.build();</span><br><span class="line">		client.start();</span><br><span class="line">		<span class="keyword">return</span> client;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * 创建节点</span><br><span class="line">	 * <span class="doctag">@param</span> client</span><br><span class="line">	 * <span class="doctag">@param</span> destPath</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createData</span><span class="params">(CuratorFramework client, String destPath)</span></span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">//创建节点时,如果父节点不存在,则一起被创建</span></span><br><span class="line">			String path = client.create().creatingParentsIfNeeded().withMode(CreateMode.PERSISTENT).forPath(destPath);</span><br><span class="line">			System.out.println(<span class="string">"finish create path:"</span> + path);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * 删除节点</span><br><span class="line">	 * <span class="doctag">@param</span> client</span><br><span class="line">	 * <span class="doctag">@param</span> destPath</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deleteData</span><span class="params">(CuratorFramework client, String destPath)</span></span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">//删除一个节点,强制保证删除</span></span><br><span class="line">			client.delete().guaranteed().forPath(destPath);</span><br><span class="line">			System.out.println(<span class="string">"success delete path:"</span> + destPath);</span><br><span class="line">			createData(client, destPath);</span><br><span class="line">			<span class="comment">//删除一个节点,强制并递归删除所有子节点</span></span><br><span class="line">			client.delete().deletingChildrenIfNeeded().forPath(<span class="string">"/curator-test"</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>参考:    </p>
<ul>
<li><a href="http://www.broadview.com.cn/#book/bookdetail/bookDetailAll.jsp?book_id=12ccd70f-a944-11e4-9c0a-005056c00008&amp;isbn=978-7-121-24967-9" target="_blank" rel="external">从Paxos到Zookeeper：分布式一致性原理与实践</a></li>
</ul>
	  

	  <div>
  		<center>
		  <div class="pagination">
<ul class="pagination">
	
	
	
	
	
		
			
			
		
	
		
			
			
			
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
		
	
	
		<li class="prev disabled"><a><i class="fa fa-arrow-circle-o-left"></i>prev</a></li>
	
	<li><a href="/"><i class="fa fa-archive"></i>Home</a></li>
	
		<li class="next"><a href="/2015/12/14/zookeeper/curator/" class="alignright next">next<i class="fa fa-arrow-circle-o-right"></i></a></li>
	
</ul>
</div>

		</center>
	  </div>
	  
	</div> <!-- col-md-9/col-md-12 -->
	
  </div><!-- row -->

	</div>
  </div>
  <div class="container-narrow">
	<footer> <p>
  &copy; 2016 Jassassin
  
      with help from <a href="http://zespia.tw/hexo/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-wixo/">Wixo</a>.    
</p> </footer>
  </div> <!-- container-narrow -->
  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/jquery.tableofcontents.min.js"></script>
<script src="/js/tocgenerator.min.js"></script>
<script src="/js/main.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
</html>
